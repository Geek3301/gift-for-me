class PgClassProperties{constructor(){}init(){this.cats=[],this.cats_map={}}getCat(e){return this.cats_map[e]}addProperty(e,s,t,n){var a=new PgAddClassContextMenuProperty(s,t,n);this.getCat(e).add(a)}}class PgAddClassContextMenuItem{constructor(e){this.key=e,this.menu=null}setMenu(e){this.menu=e}}class PgAddClassContextMenuCategory extends PgAddClassContextMenuItem{constructor(e,s){super(e),this.name=s,this.items=[]}add(e){this.items.push(e)}getAction(s,t){this.setMenu(s);var e=this.items.map(function(e){return e.getAction(s,t)});return{label:this.name,submenu:e}}}class PgAddClassContextMenuProperty extends PgAddClassContextMenuItem{constructor(e,s,t,n){super(e),this.name=s,this.values=t,this.full_name=null,this.fdef=n}setValue(e){this.menu.setClass(this,e)}getAction(e,s){function t(){i.setValue(this.key)}function n(){s.setClass(this.key,i.values)}function a(){s.restore()}var l,o,i=this;this.setMenu(e);return this.fdef&&"color"===this.fdef.type?(o={},this.values.forEach(function(e){var s=e.key.split("-"),t=s.pop(),s=s.join("-");e.base=s,e.suf=t,o[s]?o[s].push(e):o[s]=[e]}),l=[],$.each(o,function(e,s){1===s.length?l.push({label:s[0].suf+`<color><colorbox style="margin-left:8px;background-color:${s[0].color}"></colorbox></color>`,label_plain_text:s[0].suf,key:s[0].key,action:t,on_mouseenter:n,on_mouseleave:a}):l.push({label:e,submenu:s.map(function(e){return{label:e.suf+`<color><colorbox style="margin-left:8px;background-color:${e.color}"></colorbox></color>`,label_plain_text:e.suf,key:e.key,action:t,on_mouseenter:n,on_mouseleave:a}})})})):l=this.values.map(function(e){return{label:e.name,key:e.key,action:t,on_mouseenter:n,on_mouseleave:a}}),{label:this.name,full_name:this.full_name,submenu:l}}}class PgSmartInputForAddClassMenu extends PgSmartInputForMenu{constructor(e){super(),this.add_class_action=e,this.matcher=new PgSmartGeneralMatcher}async getResultsForShorthand(e){var s=await super.getResultsForShorthand(e);if(e){for(var t=!1,n=0;n<s.length;n++)if(s[n].key===e){t=!0;break}t||s.push({label:`Add class <small style="text-transform: none;">${e}</small>`,key:e,action:this.add_class_action})}return s}}class PgAddClassContextMenu{constructor(e,s,t){this.pgel=e,this.page=e?e.getPage():pinegrow.getSelectedPage(),this.class_style=s,this.prefix=t||"",this.source=null,this.onClassSet=function(){},this.list=[],pinegrow.dispatchEvent("on_get_classes_menu",this.page,this.pgel,this.list)}setClass(e,s){var t=this,n=s,a=this.class_style;this.classPreview&&this.classPreview.restore();a=(new PgApi).setClassProperty(this.pgel,this.prefix+n,e.values.map(function(e){return{key:t.prefix+e.key}}),a,{source:this.source});return a&&this.onClassSet(n),this.classPreview&&this.classPreview.remember(),a}getMenu(e){var t=this,n=[],s=(this.pgel?this.classPreview=new PgFastDOMClassPreviewForPgel(this.pgel,this.prefix):this.class_style&&(this.class_style.component?this.classPreview=new PgFastDOMClassPreviewForSelector(this.class_style.getSelector(),this.prefix):(s=pinegrow.selectedElements.getLastSelected())&&this.class_style.doesPgelHasThisStyle(s)&&(this.classPreview=new PgFastDOMClassPreviewForPgel(s,this.prefix))),this.list.forEach(function(e){var s=e.getAction(t,t.classPreview);n.push(s)}),n.push({type:"divider"}),n.push({label:"Keep the menu open",helptext:"Enable to keep the menu open after a class is selected. Useful for adding multiple classes quickly. Use ESC key to close the menu.",check:"1"===pinegrow.getSetting("add-class-menu-keep-open","0"),action:function(){var e=!("1"===pinegrow.getSetting("add-class-menu-keep-open","0"));pinegrow.setSetting("add-class-menu-keep-open",e?"1":"0"),pinegrow.showMode("Keep the menu open",e)}}),new CrsaContextMenu(n,e)),a=new PgSmartInputForAddClassMenu(async function(){await(new PgApi).canAddClass(null,this.key,t.class_style)&&t.setClass({values:[]},this.key)});return s.addSmartInput(a),s.keepOpenOnClick="1"===pinegrow.getSetting("add-class-menu-keep-open","0"),s.ignore_mouseenter_on_show=!0,s.onClosed=function(){t.classPreview&&t.classPreview.destroy()},s}showFor$el(e){this.getMenu(e).showForElement(e)}showForPgel(e){this.getMenu($("body")).showAtPgel(e)}showForEvent(e){this.getMenu($(e.target)).showAt(e.pageX,e.pageY)}}var PgQuickAssignClass=function(e,s){var t,n,a=e?e:null;(e=e||pinegrow.selectedElements.getLastSelected())?(t=new PgAssignClassView,n=e?e.getName({short:!0}):pinegrow.selectedElements.getName(),(n=new PgQuickWindow("Add classes to "+n,t,"quickAssignClasses",640,320,null,!0)).noRightEdge(),t.quickWin=n,t.target_pgel=a,s?n.showFor$El(s):n.showForPgel(e),t.onShown(),t.show(e),n.onDestroy=function(){}):pinegrow.showQuickMessage("Please, first select an element.")},pgAssignClassLastSearchTerm=null,PgAssignClassView=function(){async function s(e,s){void 0===s&&(s=!1);var t=g(e||u);if(t.length){for(var n=s&&r.hasClass(t[0]),a=0;a<t.length;a++){var l=t[a];n?i.removeClass(o.target_pgel,l,{event_type:"change"}):await i.canAddClass(o.target_pgel,l)&&(i.addClass(o.target_pgel,l,{event_type:"change"}),x(l))}M()}}var e=$('<div class="pg-assign-classes"></div>'),t=new PgUIView(e),o=(this.view=t,this.target_pgel=null,this),i=new PgApi,r=null,l=100,n=new PgSearchBox({placeholder:"Create or search... Use ↑, ↓ and ENTER keys.",placeholder_active:null,toolbar_on:!1}),c=(n.getToolbar(),n.$element.appendTo(e),null),u=null,g=(n.onSearch=function(e){try{pgAssignClassLastSearchTerm=u=e,c=e.length?new RegExp(g(e).join("|"),"i"):null,A(),M()}catch(e){}},this.onShown=function(){n.focus()},function(e,s){var t=e.split(/[\s,]+/),n=[];return t.forEach(function(e){(e=$.trim(e)).length&&(s&&(e=escapeRegExp(e)),n.push(e))}),n});(new PgSearchBoxSpacer).$element.appendTo(e);function a(e){new PgClassButtonHelper(e)}async function p(e,s){e.preventDefault();var t,n,a=$(e.currentTarget);a.hasClass("show-more")?y():(t=a.attr("data-class"),r&&(n=!0,r.hasClass(t)?(i.removeClass(o.target_pgel,t,{source:o}),n=!1):await i.canAddClass(o.target_pgel,t)&&(i.addClass(o.target_pgel,t,{source:o}),x(t),s||M()),_(t,n,a),b()))}function d(e,s,t){var n=pinegrow.selectedElements.getLastSelected();o.show(n),o.quickWin.setTitle("Add classes to "+pinegrow.selectedElements.getName())}function h(e,s,t){s!=r||t.source&&t.source==o||(b(),S())}$('<button class="btn btn-primary">Add class</button>').appendTo(n.$element).on("click",function(e){e.preventDefault(),s(null,!1)});var e=$('<div class="pg-assign-classes-c"></div>').appendTo(e),f=$('<div class="pg-assign-classes-all pg-list"><p>All</p></div>').appendTo(e),w=$('<div class="pg-assign-classes-assigned"><p>Assigned</p></div>').appendTo(e),e=$('<div class="pg-assign-classes-recent pg-list"><p>Recent <button class="pg-button" style="padding: 0 5px;margin-left: 4px;">Clear...</button></p></div>').appendTo(e),v=$('<ul class="pg-assign-classes-list"></ul>').appendTo(f),C=$('<ul class=""></ul>').appendTo(w),m=$('<ul class="pg-assign-classes-list"></ul>').appendTo(e),P=(e.find("button").on("click",function(e){pinegrow.showAlert(`<p>Are you sure you want to clear the list of recent classes?</p>`,"Please confirm","Cancel","Yes, clear the list",null,function(){pinegrow.recentClasses.clear(),M()})}),new PgArrowsMover(n.getInput(),v,"> li")),y=(P.onEnter=function(e){e?e.hasClass("show-more")?y():s(e.attr("data-class"),!0):s()},function(){l=9999999,A()}),_=(v.on("click","li",function(e){p(e,!1)}),m.on("click","li",function(e){p(e,!0)}),function(e,s,t){t=t||v.add(m).find('[data-class="'+e+'"]'),s?t.addClass("has-class"):t.removeClass("has-class")}),S=function(){var s;v.add(m).find(".has-class").removeClass("has-class"),r&&(s=[],r.getClasses().forEach(function(e){s.push('[data-class="'+e+'"]')}),s.length)&&v.add(m).find(s.join(",")).addClass("has-class")},k=(C.on("click","li",async function(e){e.preventDefault(),e.stopPropagation();var s=$(this),t=s.attr("data-class");r&&(r.hasClass(t)?(i.removeClass(o.target_pgel,t,{source:o}),s.addClass("class-off"),_(t,!1)):await i.canAddClass(o.target_pgel,t)&&(i.addClass(o.target_pgel,t,{source:o}),s.removeClass("class-off"),x(t,!0)&&M(),_(t,!0)))}),C.on("click",".crsa-input-rule-remove",function(e){var s=$(this).parent().attr("data-class");r&&(i.removeClass(o.target_pgel,s),e.preventDefault(),e.stopPropagation())}),a(v),a(C),a(m),function(e){return e.startsWith("<span")?e:escapeHtmlCode(e)}),A=function(){for(var e=r?pinegrow.insight.getClassesForPage(r.getPage()):pinegrow.insight.getClasses(),s="",t=0,n=0;n<e.length;n++)if(!c||e[n].key.match(c)){t++;var a=r&&r.hasClass(e[n].key);if(s+='<li class="'+(a?"has-class":"")+'" data-class="'+e[n].key+'" data-id="'+e[n].id+'">'+k(e[n].html||e[n].name)+"</li>",l==t){s+='<li class="show-more">'+l+" results shown. Show all.</li>";break}}P.update("data-id",function(){v.get(0).innerHTML=s})},b=function(){var e="";if(r)for(var s=r.getClasses(),t=0;t<s.length;t++)e+='<li class="pg-button pg-class-button" data-class="'+s[t]+'">'+k(s[t])+'<i class="icon icon-close crsa-input-rule-remove"></i></li>';C.get(0).innerHTML=e},x=function(e,s){return pinegrow.recentClasses.add(e,s)},M=function(){for(var e="",s=pinegrow.recentClasses.getRecent(),t=0;t<s.length;t++)s[t]&&(e+='<li class="'+(r&&r.hasClass(s[t])?"has-class":"")+'" data-class="'+s[t]+'">'+k(s[t])+"</li>");m.get(0).innerHTML=e,0};this.show=function(e){r=e,0&&pgAssignClassLastSearchTerm&&pgAssignClassLastSearchTerm!=u?n.setValue(pgAssignClassLastSearchTerm):(A(),M()),b()};t.onResize=function(){},pinegrow.addEventHandler("on_selected_elements_changed",d),pinegrow.addEventHandler("on_page_changed",h),t.onDestroy=function(){pinegrow.removeEventHandler("on_selected_elements_changed",d),pinegrow.removeEventHandler("on_page_changed",h)}},PgRecentClasses=function(){var t=this,a=null,l=100;this.add=function(e,s){if(!e)return!1;this.getRecent();var t=!1,n=a.indexOf(e);return 0<=n?s||(a.splice(n,1),t=!0):s=!1,s||(a.unshift(e),t=!0),a.length>l&&(a.splice(l,a.length-l),t=!0),t&&this.save(),t},this.getRecent=function(){if(null===a){var e=pinegrow.getCurrentProject();if(e){e=e.getProjectInfo();a=e.getSetting("recent-classes")||[]}else if(a=[],localStorage.pgRecentClasses)try{a=JSON.parse(localStorage.pgRecentClasses)}catch(e){}}return a},this.save=function(){var e=pinegrow.getCurrentProject();e?((e=e.getProjectInfo()).setSetting("recent-classes",a),e.save()):localStorage.pgRecentClasses=JSON.stringify(a)},this.clear=function(){a=[],this.save()},pinegrow.addEventHandler("on_project_loaded",function(e,s){a=null,t.getRecent()}),pinegrow.addEventHandler("on_project_closed",function(e,s){a=null})},PgClassButtonHelper=function(e,a,l){e.on("contextmenu","li",function(e){var s,t=$(this),n=t.attr("data-class");return n&&(s=new CrsaContextMenu(null,$(this)),pgf.edit_html&&a&&(s.add("Toggle",null,async function(){var e=new PgApi;a.hasClass(n)?(e.removeClass(null,n,{source:l}),t.addClass("class-off")):await e.canAddClass(null,n)&&(e.addClass(null,n,{source:l}),t.removeClass("class-off"))}),a.hasClass(n))&&s.add("Remove",null,function(){(new PgApi).removeClass(null,n,{source:l}),t.addClass("class-off")}),pgf.edit_css&&(s.add("Create CSS rule...",null,function(){o(n)}),s.add("Explore CSS rules...",null,function(){i(n)}),pinegrow.isClassTreeSupported())&&(s.add({type:"divider"}),(new PgApi).twGetMenuActionsFor(a,pinegrow.classStyles.getPgelStyleWithClass(a,n),n,null).forEach(function(e){s.add(e)})),s.showAt(e.pageX,e.pageY)),!1});var o=function(e){pinegrow.showUIPanel("style"),pinegrow.activeCSSView.openCreateNewRuleDialog("."+e,null,null,e)},i=function(e){pinegrow.showUIPanel("style"),pinegrow.activeCSSView.show(null,"."+e)}};